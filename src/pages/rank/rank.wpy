<!--  -->
<template>
    <view class="rank-page">
        <view class="rank-search">
            <van-tabs class="tabs" bind:change="onChange" bind:click="onClickTabs" active="{{ active }}">
                <van-tab title="全部"></van-tab>
                <van-tab title="同城"></van-tab>
                <van-tab title="星座"></van-tab>
            </van-tabs>
            <image wx:if="{{!showConstellation && active !== 2}}" src="../../images/rank/down-pic.png" mode="aspectFill" class="rank-down-pic"></image>
            <image wx:if="{{!showConstellation && active === 2}}" src="../../images/rank/down-pic.png" mode="aspectFill" class="rank-down-pic spe"></image>
            <image wx:if="{{showConstellation && active === 2}}" src="../../images/rank/down-pic.png" mode="aspectFill" class="rank-down-pic roate"></image>
            <block wx:if="{{showConstellation}}">
                <Constellation @getRankListByXZ.user="getRankListByXZ"></Constellation>
            </block>
        </view>
        <block wx:if="{{top3.length}}">
            <rankList :top3.sync="top3" :topOthers.sync="topOthers" :by.sync="by"></rankList>
        </block>
        <block wx:else>
            <empty></empty>
        </block>
        <image class="menu" mode="aspectFill" src="../../images/profile/menu.png" @tap="showchangeGenderPop"></image>
        <view class="drawer_screen" catchtouchmove="myCatchTouch" wx:if="{{changeGenderPop}}">
            <view class="drawer-btn" @tap="changeGender">
                <image src="../../images/rank/rank-change-gender.png" mode="aspectFill" class="btn"></image>
                <view class="textWrap">
                    <view>切换性别</view>
                </view>
            </view>
            <view class="drawer-btn" @tap="toMyRank">
                <image src="../../images/rank/rank-my-rank.png" mode="aspectFill" class="btn"></image>
                <view class="textWrap">
                    <view>我的排名</view>
                </view>
            </view>
            <image src="../../images/profile/close1.png" mode="aspectFill" class="layer-close" @tap="hidechangeGenderPop"></image>
        </view>
    </view>
</template>
<script>
import wepy from 'wepy';
import { get } from '@/utils/request';
import { RANK_LIST } from '@/utils/url';
import rankList from '@/components/rank/rankList';
import Constellation from '@/components/rank/Constellation';
import empty from '@/components/empty';
export default class fabu extends wepy.page {
    config = {
        navigationBarTitleText: '排行榜',
        usingComponents: {
            'van-tabs': '../../components/vant/tabs/index',
            'van-tab': '../../components/vant/tab/index'
        }
    };
    data = {
        all: [1, 2, 3, 4, 5, 6, 7],
        top3: [],
        topOthers: [],
        showConstellation: false,
        gender: '1',
        changeGenderPop: false,
        by: 'all',
        active: 0,
    };

    components = {
        rankList,
        Constellation,
        empty,
    };

    myCatchTouch() {
        return;
    }

    onClickTabs(event) {
        console.log('event.detail.index', event.detail.index);
        const { index } = event.detail;
        if (+index === 2) {
            // 点击星座tab
            this.showConstellation = !this.showConstellation;
        }
    }
    onChange(event) {
        console.log('event.detail.index', event.detail.index);
        const { index } = event.detail;
        this.active = index;
        if (+index === 2) {
            // 点击星座tab
            this.showConstellation = true;
        } else if (+index === 1) {
            // 点击同城
            this.showConstellation = false;
            this.by = '';
            this.getRankList({
                by: '',
                gender: this.gender
            });
        } else if (+index === 0) {
            // 点击全国
            this.showConstellation = false;
            this.by = 'all';
            this.getRankList({
                by: 'all',
                gender: this.gender
            });
        }
    }

    getTabStyle() {
        return 'background:red';
    }

    methods = {
        async getRankListByXZ(obj) {
            this.showConstellation = false;
            this.by = obj.by || '';
            await this.getRankList(obj);
        },
        showchangeGenderPop() {
            this.changeGenderPop = true;
        },
        hidechangeGenderPop() {
            this.changeGenderPop = false;
        },
        changeGender() {
            this.gender = this.gender === '1' ? '0'  : '1';
            this.hidechangeGenderPop();
            this.getRankList({
                by: this.by,
                gender: this.gender
            });
        },
        toMyRank() {
            this.hidechangeGenderPop();
            wepy.navigateTo({
                url: `/pages/my/myrank`
            });
        }
    };
    hidechangeGenderPop() {
        this.changeGenderPop = false;
    }
    events = {};

    watch = {};

    computed = {};

    onLoad() {
        this.getRankList({
            by: 'all',
            gender: this.gender
        });
    }

    onShow() {}

    async getRankList({ by = '', gender = '' }) {
        let data = await get(RANK_LIST, {
            by,
            gender: gender || this.gender
        });
        data = data.map((item) => {
            if (item.distance) {
                item.distance = (item.distance / 1000).toFixed(2);
            }
            return item;
        });
        this.top3 = data.filter((x, index) => index <= 2);
        this.topOthers = data.filter((x, index) => index > 2);
        this.$apply();
        console.log(data);
    }
}
</script>

<style lang='less'>
.rank-page {
    .rank-search {
        width: 50vw;
        margin-bottom: 30rpx;
        position: relative;
        .rank-down-pic{
            position: absolute;
            display: inline-block;
            width: 23rpx;
            height: 20rpx;
            right: 0rpx;
            top: 50%;
            margin-top: -8rpx;
            z-index: 2;
        }
        .roate{
            transform: rotate(180deg);
            right: -23rpx !important;
        }
        .spe{
            right: -23rpx !important;
        }
        .tabs {
            .van-tab--active {
                font-size: 42rpx !important;
                font-weight: 600 !important;
                z-index: 1;
            }
            .van-tabs__line {
                width: 77rpx !important;
                height: 10rpx !important;
                bottom: 28% !important;
                left:-1% !important;
            }
        }
    }
    .menu {
        width: 120rpx;
        height: 120rpx;
        border-radius: 100%;
        position: fixed;
        bottom: 8%;
        right: 9%;
    }
    .drawer_screen {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        background: rgba(6, 6, 6, 0.89);
        overflow: hidden;
        .layer-close {
            width: 170rpx;
            height: 170rpx;
            position: fixed;
            bottom: 67rpx;
            right: 107rpx;
        }
        .drawer-btn {
            display: flex;
            position: fixed;
            bottom: 100rpx;
            width: 300rpx;
            right: 0;
            align-items: center;
            flex-wrap: nowrap;
            margin-right: 60rpx;
            &:nth-child(1) {
                bottom: 418rpx;
            }
            &:nth-child(2) {
                bottom: 247rpx;
            }
            image {
                width: 174rpx;
                height: 174rpx;
                overflow: auto;
            }
            view {
                display: block;
                width: 123rpx;
                font-size: 30rpx;
                color: white;
                font-family: PingFang SC;
                font-weight: 600;
                position: relative;
                top: -4rpx;
            }
        }
    }
}
</style>
